name: Tests

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  tests:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
    - uses: actions/checkout@v4
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential
        
    - name: Run tests and generate report
      run: |
        # Create tests directory
        mkdir -p _site/tests_report
        
        # Run tests and capture output, stripping ANSI escape sequences
        make tests | sed 's/\x1b\[[0-9;]*m//g' | tee test_output.txt
        
        # Convert test output to HTML
        cat > _site/tests_report/index.html << 'EOF'
        <!DOCTYPE html>
        <html>
        <head>
            <title>RayforceDB Tests Report</title>
            <style>
                body {
                    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
                    max-width: 1200px;
                    margin: 0 auto;
                    padding: 20px;
                    background: #f6f8fa;
                }
                .container {
                    background: white;
                    padding: 20px;
                    border-radius: 6px;
                    box-shadow: 0 1px 3px rgba(0,0,0,0.12);
                }
                .header {
                    margin-bottom: 20px;
                    padding-bottom: 20px;
                    border-bottom: 1px solid #e1e4e8;
                }
                .test-result {
                    padding: 10px;
                    margin: 5px 0;
                    border-radius: 4px;
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                }
                .test-result:nth-child(odd) {
                    background: #f6f8fa;
                }
                .passed {
                    color: #28a745;
                    font-weight: 500;
                }
                .failed {
                    color: #cb2431;
                    font-weight: 500;
                }
                .time {
                    color: #6a737d;
                    margin-left: 10px;
                }
                .summary {
                    font-size: 1.2em;
                    margin: 20px 0;
                    padding: 15px;
                    background: #f1f8ff;
                    border-radius: 4px;
                }
                .name {
                    font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace;
                }
                .status-group {
                    display: flex;
                    align-items: center;
                }
            </style>
        </head>
        <body>
            <div class="container">
                <div class="header">
                    <h1>RayforceDB Tests Report</h1>
                </div>
        EOF
        
        # Process test output and append to HTML
        {
            echo "<div class=\"summary\">"
            grep "Total tests:" test_output.txt
            echo "</div><div class=\"results\">"
            grep "Running test_" test_output.txt | while read -r line; do
                test_name=$(echo "$line" | cut -d' ' -f2)
                result=$(echo "$line" | grep -o "Passed\|Failed")
                time=$(echo "$line" | grep -o "[0-9.]\+ ms")
                echo "<div class=\"test-result\">"
                echo "<span class=\"name\">$test_name</span>"
                echo "<span class=\"status-group\">"
                if [ "$result" = "Passed" ]; then
                    echo "<span class=\"passed\">✓ Passed</span>"
                else
                    echo "<span class=\"failed\">✗ Failed</span>"
                fi
                echo "<span class=\"time\">$time</span>"
                echo "</span>"
                echo "</div>"
            done
            echo "</div>"
        } >> _site/tests_report/index.html
        
        # Close HTML
        echo '</div></body></html>' >> _site/tests_report/index.html

    - name: Setup Pages
      uses: actions/configure-pages@v4
      
    - name: Upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: _site
        
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4 